<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Centos 7 and systemd-nspawn</title>
    <meta name="description" content="">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="/centos/systemd/nspawn/systemd-nspawn/centos7/containers/2015/04/18/systemd-nspawn-centos-7.html">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Drewskiwooskie Blogarooskie</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
          <a class="page-link" href="/archive.html">Archive</a>
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Centos 7 and systemd-nspawn</h1>
    <p class="post-meta">Apr 18, 2015</p>
  </header>

  <article class="post-content">
    <p>With systemd, comes systemd-nspawn. (I will not talk about love/hate of systemd, not in this post at least. Let’s just say
if you start out saying you are writing an init system, why does your init system takeover acpi?). Anyway, part of the systemd
monstrosity is something called nspawn. In short, its a “more powerful” chroot, but still should not be relied upon soley for security
(think defense in depth people!). Why would you use this over lxc? If you just want to run something in a chroot, its great for it.
If you need a full container, lxc is probably a better choice. Because I like to try new things, I chose systemd-nspawn to run certain
applications (http, mysql, minecraft). I also did not see many tutorials specifically targeting centos 7 which seems to be using
and older verson of systemd-nspawn/machinectl so some features are missing in those tools.</p>

<h3> Create a basic centos 7 bootstrap</h3>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">yum -y --releasever<span class="o">=</span>7 --nogpg --installroot<span class="o">=</span>/srv/yaystuff install systemd passwd yum fedora-release vim-minimal</code></pre></figure>

<p>This will install a basic bootstrap centos 7 environment</p>
<h3> Reset the password in the container </h3>
<p>If you are a good person, you are running selinux in enforcing mode. However there is a known bug in centos 7 that will not
let you change the password if you “boot” your container. So currently, you can be fancy and make modules, or be only a slightly
bad person and disable selinux, change the password, re-enable (things work fine after this point with selinux enabled)</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">setenforce 0
systemd-nspawn -D /srv/yaystuff
passwd
<span class="nb">exit
</span>setenforce 1</code></pre></figure>

<h3> Boot your container and install your fancypants stuff</h3>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">systemd-nspawn -D /srv/yaystuff/ -b</code></pre></figure>

<p>This will drop you into a shell, where you can yum install/configure to your hearts desire.</p>

<p>Note: This will also by default make your “container” listen on your network interfaces. So if you have port 80
open in your firewall, and have httpd started and listening in your container (but not on your host), it will be as if you
are serving httpd on your host.</p>

<p>When you are done installing fancy stuff, I just issue</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">halt</code></pre></figure>

<p>And it stops the container and takes you out of your chroot.</p>

<p>You can also bind paths outside of your container into the container’s chroot</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">systemd-nspawn -D /srv/yaystuff/ -b --bind<span class="o">=</span>/path/on/host:/path/in/container</code></pre></figure>

<h3>Start your container with systemd </h3>
<p>edit the following file: /etc/systemd/system/yaystuff.service</p>
<pre>
[Unit]
Description=yaystuff container

[Service]
ExecStart=/usr/bin/systemd-nspawn -jbD /srv/yaystuff/ -bind=/path/on/host:/path/in/container
KillMode=process
</pre>
<p>Then reload systemd and start the container</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">systemd start yaystuff.service</code></pre></figure>

<p>Now the version of machinectl on centos 7.0 does not have a login feature. So you have to use nsenter. To use nsenter, you have to get the pid of your container. 
That is logged in /var/log/messages (or if you started your container from the cli)</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">grep -A 1 <span class="s2">"Spawning namespace container on /srv/yaystuff"</span> /var/log/messages</code></pre></figure>

<p>Grab the pid there and then execute:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nsenter -m -u -i -n -p -t <span class="nv">$PID</span></code></pre></figure>

<p>To leave just type exit.</p>

<p>Excellent reference: <a href="http://0pointer.de/blog/projects/changing-roots.html">http://0pointer.de/blog/projects/changing-roots.html</a></p>

<h2 id="update">UPDATE:</h2>

<p>Redhat 7.2 (CentOS Linux release 7.2.1511) has a newer version of machinectl that has login. No need to use nsenter anymore.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">machinectl list
MACHINE                          CONTAINER SERVICE         
php-fpm                          container nspawn          
mysql                            container nspawn          
webstuff                         container nspawn          

machinectl login mysql
Connected to container mysql. Press ^] three <span class="nb">times </span>within 1s to <span class="nb">exit </span>session.

Debian GNU/Linux stretch/sid drewstud.com pts/0

drewstud login: </code></pre></figure>


  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Drewskiwooskie Blogarooskie</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Drewskiwooskie Blogarooskie</li>
          <li><a href="mailto:"></a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          

          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text"></p>
      </div>
    </div>

  </div>

</footer>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59814142-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>

</html>
