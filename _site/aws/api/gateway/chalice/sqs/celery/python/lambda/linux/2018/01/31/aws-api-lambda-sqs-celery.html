<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Setting up AWS API Gateway using Chalice, SQS and Celery</title>
    <meta name="description" content="">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://localhost:4000/aws/api/gateway/chalice/sqs/celery/python/lambda/linux/2018/01/31/aws-api-lambda-sqs-celery.html">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Drewskiwooskie Blogarooskie</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
          <a class="page-link" href="/archive.html">Archive</a>
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Setting up AWS API Gateway using Chalice, SQS and Celery</h1>
    <p class="post-meta">Jan 31, 2018</p>
  </header>

  <article class="post-content">
    <h3 id="end-goal">End Goal</h3>
<p>To have an api that sends SQS messages to a queue to be processed by workers.</p>

<h3 id="flow">Flow</h3>
<p>api request -&gt; AWS API Gateaway -&gt; SQS -&gt; Celery</p>

<h4 id="why">Why?</h4>
<p>Why manage an api for yourself when chalice and AWS can handle it quite easily for you. Yes the cloud is someone else’s computer, but I don’t want to be woken up because a server is down. I would rather be notified because a behemouth like Amazon is down.</p>

<h3 id="setup">Setup</h3>

<h4 id="create-chalice-appliction">Create Chalice Appliction</h4>
<p>I use python3 for everything. 3 &gt; 2 so python3 is obviously better. We will also use the default project names. Keeps it simple. A lot taken from their README</p>
<ul>
  <li>Create virtualenv for program</li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">python3.6 <span class="nt">-m</span> venv chalice-demo
<span class="nb">cd </span>chalice-demo
<span class="nb">.</span> ./bin/actiavate
pip install <span class="nv">chalice</span><span class="o">==</span>1.1.0
pip install <span class="nv">celery</span><span class="o">==</span>4.1.0</code></pre></figure>

<p>Since Chalice is for Amazon, you need to setup your Amazon credentials</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>mkdir ~/.aws
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;&gt;</span> ~/.aws/config
<span class="o">[</span>default]
<span class="nv">aws_access_key_id</span><span class="o">=</span>YOUR_ACCESS_KEY_HERE
<span class="nv">aws_secret_access_key</span><span class="o">=</span>YOUR_SECRET_ACCESS_KEY
<span class="nv">region</span><span class="o">=</span>YOUR_REGION <span class="o">(</span>such as us-west-2, us-west-1, etc<span class="o">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">chalice new-project chalice_project
<span class="nb">cd </span>chalice_project</code></pre></figure>

<p>Then create app.py inside the chalice_project directory with the following contents:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">chalice</span> <span class="kn">import</span> <span class="n">Chalice</span><span class="p">,</span> <span class="n">IAMAuthorizer</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>


<span class="n">broker_url</span><span class="o">=</span><span class="s">'sqs://&lt;user api key id&gt;:&lt;user api secret key&gt;@'</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Chalice</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="s">'chalice_project'</span><span class="p">)</span>

<span class="n">authorizer</span> <span class="o">=</span> <span class="n">IAMAuthorizer</span><span class="p">()</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">api_key_required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">authorizer</span><span class="o">=</span><span class="n">authorizer</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">'hello'</span><span class="p">:</span> <span class="s">'world'</span><span class="p">}</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/sendtosns'</span><span class="p">,</span> <span class="n">api_key_required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">authorizer</span><span class="o">=</span><span class="n">authorizer</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sendto_sqs</span><span class="p">():</span>

    <span class="n">sqs</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s">'sqs'</span><span class="p">)</span>
    <span class="c"># assuming you are using a fifo queue</span>
    <span class="n">queue_url</span> <span class="o">=</span> <span class="s">'https://sqs.us-east-1.amazonaws.com/&lt;aws account id&gt;/&lt;queue name&gt;.fifo'</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">celery</span><span class="o">=</span><span class="n">Celery</span><span class="p">(</span><span class="n">broker</span><span class="o">=</span><span class="n">broker_url</span><span class="p">)</span>
        <span class="n">celery</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">task_default_queue</span> <span class="o">=</span><span class="s">'&lt;queue name&gt;.fifo'</span>
        <span class="n">celery</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">CELERY_ACCEPT_CONTENT</span><span class="o">=</span><span class="p">[</span><span class="s">"json"</span><span class="p">],</span>
                <span class="n">CELERY_TASK_SERIALIZER</span><span class="o">=</span><span class="s">"json"</span><span class="p">,</span>
                <span class="n">CELERY_RESULT_SERIALIZER</span><span class="o">=</span><span class="s">"json"</span><span class="p">,</span>
                <span class="n">CELERY_DEFAULT_QUEUE</span><span class="o">=</span><span class="s">'environment_queue.fifo'</span><span class="p">)</span>

        <span class="n">celery</span><span class="o">.</span><span class="n">send_task</span><span class="p">(</span><span class="s">"tasks.add"</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">'{"error occurred":"check cloudwatch logs"}'</span>

    <span class="k">return</span> <span class="s">'{"message_status":"success"}'</span>
    </code></pre></figure>

<p>Also add the following to requirements.txt</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">celery</span><span class="o">==</span>4.1.0</code></pre></figure>

<p>Notice a few things here. We need to create a SQS queue, and we need our aws credentials. For testing that is fine to leave those in there, but I would HIGHLY recommend using AWS KMS Keys for the data. This is just to get things working.</p>

<p>You can also use your AWS “master” account, but below I will show the polcies that I used to make it work.</p>

<p>Go to your aws dashboard (or use cloudformation) and make your SQS FIFO queue.</p>

<p>Now it is time to deploy your chalice app!</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">chalice deploy</code></pre></figure>

<p>Any credentials or permissions you are missing for that user are made clear here. If you are using your master account, it should work just fine. It is creating the lambda, creating permissions, and making the api gateay. Really, it is setting up the API Gateway -&gt; Lambda function method execution for you. Anything I do not have to do manually is a win.</p>

<p>In addition, it uploads any depencies you installed via pip, amazing!</p>

<p>Something else to notice as well, we added ‘api_key_required=True, authorizer=authorizer’ to the constructor, so yes, we will need to auth, TWICE! Why not, security rocks. You can remove those from the constructor and have it be unauthenticated, but whats the fun in that!</p>

<h4 id="adding-api-key-to-endpoint">Adding api key to endpoint</h4>
<p>You can probably do this with cloudformation or aws api, but for this tutorial we will use the console</p>

<ul>
  <li>In your AWS Console (web interface) go to Services and choose API Gateway</li>
  <li>Go to API Keys</li>
  <li>Under actions, select “Create API Key”</li>
  <li>Give it a name. I let is autogenerate but if I am very paranoid I will generate my own.</li>
  <li>Hit Save</li>
  <li>Go to  “Usage Plans”</li>
  <li>Hit Create</li>
  <li>Give it a name (Basic is fine for this demo)
    <ul>
      <li>Usage plans let you rate limit, throttle, etc… based on api key</li>
    </ul>
  </li>
  <li>After hitting save, select your newly created Usage Plan</li>
  <li>Select “Add API Stage”
    <ul>
      <li>An API Stage lets you deploy code to different “Stages”. You could have a stage for dev, pre-prod, prod, hamster, etc..</li>
      <li>If you wanted a new stage, its as easy as “chalice deploy –stage penguin”</li>
    </ul>
  </li>
  <li>Under api you should have your api selected</li>
  <li>Under stage, if its default you can enter in api, or choose whatever stage you want it to be.</li>
  <li>Hit that tiny checkmark beside it</li>
</ul>

<p>There, now you have an api key to hit this API. We also chose IAM authentication. That means we have to use AWS Signature Version 4 singing. Don’t worry, smart people already made a python module for this.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">pip install aws-requests-auth<span class="o">==</span>0.4.1
pip install <span class="nv">requests</span><span class="o">==</span>2.18.4</code></pre></figure>

<p>And then to test the api, we have this snazzy little python program. Let’s name is snazzy.py</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">aws_requests_auth.aws_auth</span> <span class="kn">import</span> <span class="n">AWSRequestsAuth</span>

<span class="n">auth</span> <span class="o">=</span> <span class="n">AWSRequestsAuth</span><span class="p">(</span><span class="n">aws_access_key</span><span class="o">=</span><span class="s">'&lt;your aws access key id&gt;'</span><span class="p">,</span>
                       <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="s">'&lt;your aws access secrey key&gt;,</span><span class="err">
</span><span class="s">                       aws_host='</span><span class="mi">123456</span><span class="n">abcde</span><span class="o">.</span><span class="n">execute</span><span class="o">-</span><span class="n">api</span><span class="o">.</span><span class="n">us</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mf">1.</span><span class="n">amazonaws</span><span class="o">.</span><span class="n">com</span><span class="s">',</span><span class="err">
</span><span class="s">                       aws_region='</span><span class="n">us</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mi">1</span><span class="s">',</span><span class="err">
</span><span class="s">                       aws_service='</span><span class="n">execute</span><span class="o">-</span><span class="n">api</span><span class="s">')</span><span class="err">
</span><span class="s">headers = {'</span><span class="n">x</span><span class="o">-</span><span class="n">api</span><span class="o">-</span><span class="n">key</span><span class="s">': '</span><span class="o">&lt;</span><span class="n">api</span> <span class="n">key</span> <span class="n">you</span> <span class="n">generated</span><span class="o">&gt;</span><span class="s">'}</span><span class="err">
</span><span class="s">response = requests.get('</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mi">123456</span><span class="n">abcde</span><span class="o">.</span><span class="n">execute</span><span class="o">-</span><span class="n">api</span><span class="o">.</span><span class="n">us</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mf">1.</span><span class="n">amazonaws</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">sendtosqs</span><span class="s">',</span><span class="err">
</span><span class="s">                          auth=auth, headers=headers)</span><span class="err">
</span><span class="s">print(response.content)</span></code></pre></figure>

<p>You can get the api path by going to your api, selecting stages, your stage, then the url at the top is how to get to your url (also the end of chalice deploy tells you what it is as well)</p>

<p>Now, if things are good, we are almost done. We need to enable cloudwatch logs for the api.</p>

<p><a href="https://aws.amazon.com/premiumsupport/knowledge-center/api-gateway-cloudwatch-logs/"> AWS Documentation</a>. This is where I got my info.</p>

<ul>
  <li>Under services, select IAM</li>
  <li>Select Roles</li>
  <li>You should see something like chalice_project-dev, select that</li>
  <li>Under trust relationship, select “Edit trust relationship”</li>
  <li>It should look something like this:</li>
</ul>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="s2">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"Service"</span><span class="p">:</span><span class="w"> </span><span class="s2">"lambda.amazonaws.com"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="s2">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts:AssumeRole"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"Service"</span><span class="p">:</span><span class="w"> </span><span class="s2">"apigateway.amazonaws.com"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="s2">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts:AssumeRole"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<ul>
  <li>Select “Update Trust Policy”</li>
  <li>Back at the policy summary for chalie_project-dev, select “Attach Policy”</li>
  <li>Choose “AmazonAPIGatewayPushToCloudWatchLogs” and select “Attach Policy”</li>
  <li>Back at the policy summary page, copy the Role ARN</li>
  <li>Go to services and select API Gateay</li>
  <li>Select your API</li>
  <li>Select Stages</li>
  <li>Select your stage (api is default)</li>
  <li>Under logs select “Enable Cloudwatch logs” and hit save changes</li>
  <li>Under settings on the left hand side, under “Cloudwatch log role ARN”, paste the ARN you copied earlier and hit save
If all goes well, there should be no errors, and now your application is logging to cloudwatch!</li>
</ul>

<p>Now you can test your api, and look at cloudwatch to see if there are any issues. Just run:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">python3.6 snazzy.py</code></pre></figure>

<p>It should hit the sendtosqs endpoint and put a message on the queue! WOW!</p>

<h3 id="celery-setup">Celery setup</h3>
<ul>
  <li>Create another virtual environment somewhere</li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">python3.6 <span class="nt">-m</span> venv workers
<span class="nb">cd </span>workers
<span class="nb">.</span> ./bin/activate
pip install <span class="nv">celery</span><span class="o">==</span>4.1.0
<span class="nb">export </span><span class="nv">PYCURL_SSL_LIBRARY</span><span class="o">=</span>nss
pip install pycurl <span class="nt">--no-cache-dir</span>
pip install pycurl</code></pre></figure>

<ul>
  <li>NOTE: there may be funny things with pycurl. This is the worst part of everything. YMMV, may have to use google to figure out why it wont install. Again, so stupid.</li>
  <li>Create a file called tasks.py</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="n">broker_url</span><span class="o">=</span><span class="s">'sqs://&lt;aws key id&gt;:&lt;aws secret key&gt;@'</span>

<span class="n">broker_transport_options</span> <span class="o">=</span> <span class="p">{</span><span class="s">'queue_name_prefix'</span><span class="p">:</span> <span class="s">'&lt;queue_name&gt;.fifo'</span><span class="p">}</span>
<span class="n">CELERY_TASK_SERIALIZER</span> <span class="o">=</span> <span class="s">'json'</span>
<span class="n">CELERY_RESULT_SERIALIZER</span> <span class="o">=</span> <span class="s">'json'</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s">'tasks'</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="n">broker_url</span><span class="p">,</span> <span class="n">broker_transport_options</span><span class="o">=</span><span class="n">broker_transport_options</span> <span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">task_default_queue</span> <span class="o">=</span><span class="s">'&lt;queue_name&gt;.fifo'</span>
<span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">CELERY_ACCEPT_CONTENT</span><span class="o">=</span><span class="p">[</span><span class="s">"json"</span><span class="p">],</span>
                <span class="n">CELERY_TASK_SERIALIZER</span><span class="o">=</span><span class="s">"json"</span><span class="p">,</span>
                <span class="n">CELERY_RESULT_SERIALIZER</span><span class="o">=</span><span class="s">"json"</span><span class="p">,</span>
                <span class="n">CELERY_DEFAULT_QUEUE</span><span class="o">=</span><span class="s">'&lt;queue_name&gt;.fifo'</span><span class="p">)</span>

<span class="nd">@app.task</span><span class="p">(</span><span class="n">serializer</span><span class="o">=</span><span class="s">'json'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="n">duo</span><span class="p">):</span>
    <span class="n">my_uuid</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
    <span class="n">sleep_time</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'I got a task, and my uuid is: {} and I am sleeping {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">my_uuid</span><span class="p">,</span> <span class="n">sleep_time</span><span class="p">))</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"My uuuid is </span><span class="si">%</span><span class="s">s and I am done sleeping"</span> <span class="o">%</span> <span class="n">my_uuid</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">message</span></code></pre></figure>

<p>The point here is not to do actual work, its to show that it is reading SQS messages, and executing child tasks that are run in paralell.</p>

<p>Run the program with:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">celery <span class="nt">-A</span> tasks worker <span class="nt">--loglevel</span><span class="o">=</span>info <span class="nt">--concurrency</span><span class="o">=</span>10</code></pre></figure>

<p>If thinks work right, you should see things coming on in!</p>

<h3 id="permissions">Permissions</h3>
<p>If you do everything with an account that has full access to everything, there should be zero issues. However, that is NOT how you want to do it in production.</p>
<ul>
  <li>Here is the policy json that worked for me to have a user I create have access to deploy, update and delete a chalice app.</li>
</ul>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
    </span><span class="s2">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"VisualEditor0"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"lambda:CreateFunction"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"apigateway:DELETE"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"lambda:ListTags"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"apigateway:PUT"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"lambda:UpdateFunctionConfiguration"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"apigateway:POST"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"sqs:*"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"apigateway:GET"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="s2">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"VisualEditor1"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"iam:GetRole"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"lambda:GetFunction"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"iam:CreateRole"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"iam:DeleteRole"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"lambda:GetFunctionConfiguration"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"iam:PutRolePolicy"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"lambda:UpdateFunctionCode"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"iam:PassRole"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"lambda:AddPermission"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"iam:DeleteRolePolicy"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"lambda:DeleteFunction"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"iam:ListRolePolicies"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"lambda:GetPolicy"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="s2">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"arn:aws:iam::&lt;account id&gt;:role/chalice_project-dev"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"arn:aws:lambda:us-east-1:&lt;account id&gt;:function:chalice_project-dev"</span><span class="w">
            </span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<h4 id="api-user">API user</h4>
<p>The nice thing if you are using IAM authentication, you can make a user that can only hit certain endpoints. (There are OAUTH and custom authenticators you can use with API Gateway)</p>
<ul>
  <li>I created a user, then a group to contain that user. I then created then attached the following policy:</li>
</ul>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
    </span><span class="s2">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"VisualEditor0"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"execute-api:Invoke"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:execute-api:us-east-1:&lt;account id&gt;:12345abcde/api/GET/sendtosqs"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<ul>
  <li>This user could only hit the sendtosns endpoint using Get.</li>
</ul>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Drewskiwooskie Blogarooskie</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Drewskiwooskie Blogarooskie</li>
          <li><a href="mailto:"></a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          

          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text"></p>
      </div>
    </div>

  </div>

</footer>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59814142-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>

</html>
